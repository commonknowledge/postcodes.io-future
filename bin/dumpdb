#!/usr/bin/env bash

# Dumps postcodes.io db
# $ POSTGRSE_DB=postcodesiodb ./dumpdb.sh 

set -o errexit

if ! [ -x "$(command -v pg_dump)" ]; then
  echo 'Error: pg_dump is not installed.' >&2
  exit 1
fi

if ! [ -x "$(command -v gzip)" ]; then
  echo 'Error: gzip is not installed.' >&2
  exit 1
fi

if [ -z "$POSTGRES_URL" ]; then
  echo 'Database must be specified.' >&2
  echo 'e.g. POSTGRES_URL=postgres://u:p@locahost:5432/db ./dumpdb.sh' >&2
  exit 1
fi

TIMESTAMP=`date +%F-%H%M`

# Create backup
pg_dump --no-owner --format=plain $POSTGRES_URL | gzip > postcodesio-$TIMESTAMP.sql.gz

